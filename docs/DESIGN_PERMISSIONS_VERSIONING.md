# Permissions & Sharing — Version History\n+\n+**Status**: Design document (UI + workflow + API sketch). No implementation yet.\n+\n+Date: 2025-12-20\n+\n+Purpose: produce a single-source design for Permissions & Sharing and Version History UX/workflow so engineering and product can implement consistently after freeze.\n+\n+Principles\n+- **Safety first**: defaults must be private. Sharing is explicit.\n+- **Minimal friction**: invites and links should be simple, but safe (expiration, revocation).\n+- **Enterprise trust**: audit logs, team domains, and RBAC for enterprises.\n+- **CRDT invariant protection**: operations that mutate CRDTs (apply snapshots, restore) must respect the live-collaboration guardrail (do not apply snapshots while provider active).\n+\n+## 1 — Roles & Permission Model\n+\n+Core role types (document-level):\n+- **Owner**: Full control. Can transfer ownership, change roles, delete document.\n+- **Admin**: Manage sharing, can edit and manage invites, cannot transfer ownership.\n+- **Editor**: Can edit content and comment, create snapshots, and invite others with lesser or equal roles (optional, configurable).\n+- **Commenter**: Can comment and view history, cannot modify content.\n+- **Viewer**: Read-only.\n+\n+Notes:\n+- Role **granularity** should be extendable later (field-level, section-level) but start with document-level.\n+- Roles inherit: Owner > Admin > Editor > Commenter > Viewer.\n+\n+## 2 — Sharing Types\n+\n+- **Direct invite (email)**: Highest trust. Inviter specifies role and optional expiry. Invite appears in recipient's account.\n+- **Workspace/team share**: Grant role to entire workspace or group.\n+- **Shareable link**: Lightweight - three modes: view/comment/edit. Supports optional: expiry date, password, domain restriction (enterprise), max uses.\n+- **Public export**: Separate flow (for publishing), read-only.\n+\n+Security defaults:\n+- New documents default to Private.\n+- Share links default to Expire in 30 days (configurable) and View-only.\n+\n+## 3 — Invite & Accept Flows (UX)\n+\n+1. User clicks `Share` in editor header.\n+2. Modal opens with:\n+   - Document title and owner row\n+   - Input to invite by email (`Enter emails, press Enter`)\n+   - Dropdown to pick role (Editor/Commenter/Viewer)\n+   - Optional message\n+   - Toggle: Send email notification (on/off)\n+   - Link management area (create link, set mode, expiry, password)\n+3. Invite sent → UI shows `Pending invites` with ability to cancel.\n+4. Recipient receives email (or workspace notification) with Accept/Decline.\n+5. On Accept: user is added to document members with role.\n+\n+Micro-interactions:\n+- On invite sent: toast `Invite sent to ...` with undo for 5s.\n+- When invite accepted: live presence added and small banner `X joined`.\n+\n+Edge cases:\n+- Invite to email with existing account vs. unregistered email → show pending invite; on signup auto-claim if email matches.\n+- Revoke while invite pending → cancel invite and notify if possible.\n+\n+## 4 — Sharing Modal: Component Spec\n+\n+Top area (header): Document title, owner avatar, `Share` CTA.\n+\n+Left column — Invite form:\n+- `To:` input with suggestions from workspace and recent collaborators\n+- Role selector (inline)\n+- Send as link toggle\n+- Send email checkbox\n+\n+Right column — Link & Members:\n+- Existing share links list (mode, expiry, uses)\n+- Button: `Create share link` → opens small sheet to configure mode/expiry/password\n+- Members list (avatar, name, role badge)\n+  - Actions per member: change role (dropdown), remove, view activity\n+\n+Footer:\n+- `Save` `Cancel` actions (saving is mostly immediate; `Save` finalizes link creation)\n+\n+Animations & polish:\n+- Smooth expand/collapse for link details (200ms ease-out)\n+- Toasts for invite, revoke, link copied\n+\n+Accessibility:\n+- Keyboard friendly, proper labels, aria-live for invites status.\n+\n+## 5 — Document Header UX (quick status)\n+\n+Add `Share` icon and collaborators avatar strip in the editor header (left of sync badge). Clicking avatar or share icon opens same modal. Hover shows `X collaborators — Shared with Y`.\n+\n+Behavioral cues:\n+- If `public` link exists, show small globe icon with tooltip `Link: view` and expiration.\n+- If only private, show lock icon.\n+\n+## 6 — Version History UX / Workflow\n+\n+Goal: make history understandable, discoverable, and reversible without risking CRDT corruption.\n+\n+Primary UI: **Version Timeline Panel** — Right-docked panel opened from editor header (`History` button).\n+\n+Layout:\n+- Top: filter bar (author, date range, autosave/manual snapshots)\n+- Middle: vertical timeline list (newest first) with entries:\n+  - Snapshot card: timestamp, author (if available), snapshot type (auto/manual), note (optional), size\n+  - Actions: Preview, Compare, Restore, Create Copy\n+- Bottom: `Restore preview` area that renders document diff (rich diff if possible) and `Restore` CTA.\n+\n+Snapshot types:\n+- **Auto snapshot**: created by SnapshotManager (every N seconds/debounce). Marked `Auto` and collapsed.\n+- **Manual snapshot**: user-created (via `Save Snapshot`), shown prominently.\n+\n+Diffing:\n+- Provide two modes:\n+  1. **Rendered diff** (TipTap/HTML level): visually show differences; ideal for WYSIWYG\n+  2. **Yjs ops diff (raw)**: for power users and debugging (optional)\n+\n+Restore workflow (safety first):\n+1. User selects `Restore` on a snapshot.\n+2. App shows a preview and clearly states **“Restoring will replace current document content”**.\n+3. Because of CRDT rule: if HocuspocusProvider is active (live collaboration), block *automatic apply* and offer two options:\n+   - **Restore as new document** (recommended) — creates a new document with snapshot contents. Safer, non-destructive.\n+   - **Take document offline & restore** — requires user to confirm and will 1) pause provider, 2) create a local pre-restore backup snapshot, 3) apply the snapshot, 4) re-enable provider and snapshot the new state (advanced, require Owner/Admin).\n+4. Always create a backup snapshot of current live state before restore.\n+\n+Conflict guard: **Never apply snapshot while provider active** by default. Require explicit Owner action and show exact steps and consequences.\n+\n+## 7 — Data Model (DB sketch)\n+\n+Tables (high level):\n+\n+- `documents` (existing)\n+- `document_shares`\n+  - id\n+  - document_id\n+  - principal_type ('user'|'workspace'|'link')\n+  - principal_id (user_id / workspace_id / link_id)\n+  - role ('owner'|'admin'|'editor'|'commenter'|'viewer')\n+  - created_by\n+  - created_at\n+  - expires_at (nullable)\n+\n+- `share_links`\n+  - id\n+  - document_id\n+  - token (secure random)\n+  - mode ('view'|'comment'|'edit')\n+  - password_hash (nullable)\n+  - max_uses (nullable)\n+  - uses_count\n+  - created_at\n+  - expires_at\n+\n+- `document_snapshots`\n+  - id\n+  - document_id\n+  - created_by (nullable: system for auto)\n+  - created_at\n+  - yjs_state (binary/blob)\n+  - html_preview (nullable)\n+  - note (nullable)\n+  - type ('auto'|'manual'|'restore-backup')\n+\n+- `audit_logs`\n+  - id\n+  - actor_id (nullable if system)\n+  - action (invite_sent, invitation_accepted, role_changed, share_revoked, snapshot_restored, etc.)\n+  - metadata json\n+  - created_at\n+\n+## 8 — API Sketch (router endpoints)\n+\n+Auth: JWT required. All endpoints must validate access using `get_current_user()` and role checks.\n+\n+Sharing\n+- POST /api/v1/documents/:id/invite — body: {emails:[], role, message, sendEmail}\n+- GET /api/v1/documents/:id/members — list members and roles\n+- POST /api/v1/documents/:id/share-link — create link (mode, expiry, password)\n+- DELETE /api/v1/documents/:id/share-link/:linkId — revoke link\n+- POST /api/v1/documents/:id/transfer-ownership — body: {new_owner_id}\n+\n+Versioning\n+- GET /api/v1/documents/:id/snapshots — list snapshots (paging)\n+- GET /api/v1/documents/:id/snapshots/:snapshotId — get metadata (and html preview)\n+- GET /api/v1/documents/:id/snapshots/:snapshotId/download — download binary\n+- POST /api/v1/documents/:id/snapshots/:snapshotId/restore — body: {action: 'overwrite'|'new_document', targetDocumentId?}\n+\n+Audit\n+- GET /api/v1/documents/:id/audit-logs — for admins/owners\n+\n+## 9 — Security & Compliance\n+\n+- **Access checks**: All endpoints must verify membership/role. Owner/Admin only for revoke and transfer.\n+- **Link tokens**: use cryptographically secure tokens, verify expiration and max_uses.\n+- **Rate limiting**: invite/email endpoints rate-limited to prevent abuse.\n+- **GDPR / Data retention**: add policies for snapshot retention and deletion.\n+- **Enterprise controls**: enforce allowed domains for share links, SSO integrations.\n+\n+## 10 — Audit & Observability\n+\n+- Emit events for: invite_sent, invite_accepted, role_changed, link_created, link_revoked, snapshot_created, snapshot_restored\n+- Expose logs in Admin/Workspace settings and allow CSV export\n+\n+## 11 — Acceptance Criteria\n+\n+- Sharing modal: invite by email to at least 5 users with roles and optional message.\n+- Link creation: create, copy, revoke link; expiry enforced.\n+- Members list: change role and remove member; Owner cannot remove self without transfer.\n+- Version panel: list last 50 snapshots with preview and restore flow.\n+- Restore safety: default to `restore as new document`; advanced restore requires explicit Owner action and shows backup snapshot creation.\n+\n+## 12 — Testing Checklist\n+\n+- Unit tests for API access control (all roles)\n+- Integration tests: invite → accept → role effective\n+- UI tests: share modal flows, copy link, revoke\n+- E2E: restore snapshot while collaboration active (expect block), restore as new doc (success)\n+- Load tests for link creation & snapshot listing\n+\n+## 13 — Rollout Plan\n+\n+Phase 1 (design deliverable): this document + mocks (this file). No code changes.\n+\n+Phase 2 (backend): schema + APIs (invite, share links, snapshots) behind feature flag.\n+\n+Phase 3 (frontend): share modal UI, header badges, version panel (opt-in feature flag), telemetry.\n+\n+Phase 4 (enterprise): domain controls, audit export, SSO policy mapping.\n+\n+## 14 — Telemetry & Metrics\n+\n+- Track `share_invite_created`, `share_link_created`, `share_link_revoked`, `snapshot_restored`, `version_viewed`\n+- KPIs:\n+  - Share adoption % (shared docs / total docs)\n+  - Restore rate (restores / snapshots)\n+  - Failed restore attempts (blocked due to active provider)\n+\n+## 15 — Appendix: Wireframe Notes\n+\n+- Share Modal: compact with strong visual hierarchy. Left: invite box, Right: members+links. Primary CTA `Invite`.\n+- Version Panel: right dock, timeline with compact cards, quick preview on hover and full preview on click.\n+\n+---\n+\n+If you want, I can generate visual mockups (Figma-style specs), component props tables, or a developer README next. Which output do you prefer next? (Mocks / Component spec / API contract examples / All)\n+\n*** End Patch

