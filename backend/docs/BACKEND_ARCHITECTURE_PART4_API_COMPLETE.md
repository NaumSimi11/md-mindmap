# MD Creator Backend - Part 4: Complete API Specification

**Continuation of BACKEND_ARCHITECTURE_BLUEPRINT.md**

---

## 6. Complete API Specification

### 6.1 API Design Principles

**REST API Standards:**
- ‚úÖ Resource-oriented URLs (`/api/workspaces/{id}/documents`)
- ‚úÖ HTTP verbs for actions (GET, POST, PUT, PATCH, DELETE)
- ‚úÖ HTTP status codes (200, 201, 204, 400, 401, 403, 404, 409, 500)
- ‚úÖ JSON request/response bodies
- ‚úÖ Pagination with `limit` and `cursor`
- ‚úÖ Filtering with query parameters
- ‚úÖ Versioning via URL (`/api/v1/...`)
- ‚úÖ OpenAPI 3.0 documentation (auto-generated by FastAPI)

**Error Response Format (RFC 7807 Problem Details):**

```json
{
  "type": "https://mdcreator.app/errors/document-not-found",
  "title": "Document Not Found",
  "status": 404,
  "detail": "Document with ID '123e4567-e89b-12d3-a456-426614174000' does not exist",
  "instance": "/api/documents/123e4567-e89b-12d3-a456-426614174000",
  "timestamp": "2025-12-05T10:30:00Z",
  "trace_id": "abc123def456"
}
```

### 6.2 Authentication Endpoints

**Base URL**: `/api/v1/auth`

#### `POST /auth/signup`

Register new user account.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "display_name": "John Doe"
}
```

**Response:** `201 Created`
```json
{
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "email": "user@example.com",
  "display_name": "John Doe",
  "email_verified": false,
  "confirmation_required": true,
  "message": "Verification email sent to user@example.com"
}
```

**Errors:**
- `400 Bad Request`: Invalid email or weak password
- `409 Conflict`: Email already registered

---

#### `POST /auth/confirm`

Confirm email address with verification code.

**Request:**
```json
{
  "email": "user@example.com",
  "confirmation_code": "123456"
}
```

**Response:** `200 OK`
```json
{
  "email_verified": true,
  "message": "Email confirmed successfully"
}
```

---

#### `POST /auth/login`

Authenticate user and receive JWT tokens.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response:** `200 OK`
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "email": "user@example.com",
    "display_name": "John Doe",
    "avatar_url": "https://cdn.mdcreator.app/avatars/...",
    "subscription_tier": "free"
  }
}
```

**Errors:**
- `401 Unauthorized`: Invalid credentials
- `403 Forbidden`: Account not verified

---

#### `POST /auth/refresh`

Refresh access token using refresh token.

**Request:**
```json
{
  "refresh_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response:** `200 OK`
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

---

#### `POST /auth/logout`

Logout user (revoke refresh token).

**Headers:**
```
Authorization: Bearer {access_token}
```

**Response:** `204 No Content`

---

#### `GET /auth/me`

Get current authenticated user info.

**Headers:**
```
Authorization: Bearer {access_token}
```

**Response:** `200 OK`
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "email": "user@example.com",
  "display_name": "John Doe",
  "avatar_url": "https://cdn.mdcreator.app/avatars/...",
  "bio": "Software engineer and technical writer",
  "settings": {
    "theme": "dark",
    "editor_mode": "wysiwyg",
    "ai_enabled": true
  },
  "subscription_tier": "pro",
  "subscription_status": "active",
  "created_at": "2025-01-15T10:30:00Z",
  "last_seen_at": "2025-12-05T10:30:00Z"
}
```

---

### 6.3 Workspace Endpoints

**Base URL**: `/api/v1/workspaces`

#### `GET /workspaces`

List all workspaces user has access to.

**Headers:**
```
Authorization: Bearer {access_token}
```

**Query Parameters:**
- `limit` (optional, default: 50): Max workspaces to return
- `offset` (optional, default: 0): Pagination offset
- `type` (optional): Filter by type (`personal`, `team`)

**Response:** `200 OK`
```json
{
  "workspaces": [
    {
      "id": "ws_123e4567",
      "name": "Personal Workspace",
      "slug": "personal-workspace",
      "description": "My personal documents and notes",
      "icon": "üìù",
      "color": "#4F46E5",
      "is_personal": true,
      "is_team": false,
      "role": "owner",
      "permissions": {
        "can_create_documents": true,
        "can_edit_documents": true,
        "can_delete_documents": true,
        "can_invite_members": true,
        "can_manage_workspace": true
      },
      "storage_used_bytes": 52428800,
      "storage_limit_bytes": 1073741824,
      "document_count": 42,
      "member_count": 1,
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-12-05T09:15:00Z"
    }
  ],
  "total": 5,
  "limit": 50,
  "offset": 0
}
```

---

#### `POST /workspaces`

Create new workspace.

**Request:**
```json
{
  "name": "Project Apollo",
  "description": "Documentation for Apollo project",
  "is_team": true,
  "settings": {
    "default_permissions": "editor",
    "ai_enabled": true
  }
}
```

**Response:** `201 Created`
```json
{
  "id": "ws_456def789",
  "name": "Project Apollo",
  "slug": "project-apollo",
  "owner_id": "123e4567-e89b-12d3-a456-426614174000",
  "created_at": "2025-12-05T10:30:00Z"
}
```

---

#### `GET /workspaces/{id}`

Get workspace details.

**Response:** `200 OK`
```json
{
  "id": "ws_123e4567",
  "name": "Project Apollo",
  "slug": "project-apollo",
  "description": "Documentation for Apollo project",
  "icon": "üöÄ",
  "color": "#10B981",
  "owner": {
    "id": "user_123",
    "display_name": "John Doe",
    "avatar_url": "https://..."
  },
  "is_personal": false,
  "is_team": true,
  "settings": {
    "default_permissions": "editor",
    "require_invitation": true,
    "ai_enabled": true
  },
  "storage_used_bytes": 157286400,
  "storage_limit_bytes": 10737418240,
  "member_count": 8,
  "document_count": 156,
  "created_at": "2025-06-01T10:00:00Z",
  "updated_at": "2025-12-05T09:30:00Z"
}
```

---

#### `PATCH /workspaces/{id}`

Update workspace settings.

**Request:**
```json
{
  "name": "Project Apollo Updated",
  "description": "Updated description",
  "icon": "üåô",
  "color": "#8B5CF6",
  "settings": {
    "ai_enabled": false
  }
}
```

**Response:** `200 OK` (returns updated workspace object)

---

#### `DELETE /workspaces/{id}`

Delete workspace (soft delete).

**Response:** `204 No Content`

**Errors:**
- `403 Forbidden`: Only owner can delete workspace
- `409 Conflict`: Cannot delete workspace with active members

---

#### `GET /workspaces/{id}/members`

List workspace members.

**Response:** `200 OK`
```json
{
  "members": [
    {
      "user_id": "user_123",
      "display_name": "John Doe",
      "email": "john@example.com",
      "avatar_url": "https://...",
      "role": "owner",
      "permissions": {
        "can_create_documents": true,
        "can_edit_documents": true,
        "can_delete_documents": true,
        "can_invite_members": true,
        "can_manage_workspace": true
      },
      "joined_at": "2025-06-01T10:00:00Z",
      "last_accessed_at": "2025-12-05T09:30:00Z",
      "is_active": true
    }
  ],
  "total": 8
}
```

---

#### `POST /workspaces/{id}/members/invite`

Invite user to workspace.

**Request:**
```json
{
  "email": "alice@example.com",
  "role": "editor",
  "message": "Join our Apollo project workspace!"
}
```

**Response:** `201 Created`
```json
{
  "invitation_id": "inv_abc123",
  "email": "alice@example.com",
  "role": "editor",
  "status": "pending",
  "token": "secure_random_token",
  "expires_at": "2025-12-12T10:30:00Z",
  "invitation_link": "https://mdcreator.app/invite/secure_random_token"
}
```

---

#### `DELETE /workspaces/{id}/members/{user_id}`

Remove member from workspace.

**Response:** `204 No Content`

**Errors:**
- `403 Forbidden`: Only admin/owner can remove members
- `409 Conflict`: Cannot remove workspace owner

---

### 6.4 Document Endpoints

**Base URL**: `/api/v1/workspaces/{workspace_id}/documents`

#### `GET /workspaces/{workspace_id}/documents`

List documents in workspace.

**Query Parameters:**
- `limit` (default: 50): Max documents
- `cursor` (optional): Pagination cursor
- `type` (optional): Filter by type (`markdown`, `mindmap`, `presentation`)
- `search` (optional): Full-text search query
- `tags` (optional): Filter by tags (comma-separated)
- `sort` (optional): Sort by (`updated_at`, `created_at`, `title`)
- `order` (optional): Order (`asc`, `desc`)

**Response:** `200 OK`
```json
{
  "documents": [
    {
      "id": "doc_123abc",
      "title": "Getting Started with MD Creator",
      "type": "markdown",
      "metadata": {
        "tags": ["tutorial", "getting-started"],
        "category": "Documentation",
        "status": "published"
      },
      "content_hash": "a3f5d1e2...",
      "creator": {
        "id": "user_123",
        "display_name": "John Doe",
        "avatar_url": "https://..."
      },
      "view_count": 142,
      "comment_count": 8,
      "version_count": 15,
      "created_at": "2025-11-01T10:00:00Z",
      "updated_at": "2025-12-05T09:00:00Z",
      "last_viewed_at": "2025-12-05T09:30:00Z"
    }
  ],
  "cursor": "eyJsYXN0X2lkIjoiZG9jXzEyM2FiYyIsInNjb3JlIjoxMjM0fQ==",
  "has_more": true,
  "total": 156
}
```

---

#### `POST /workspaces/{workspace_id}/documents`

Create new document.

**Request:**
```json
{
  "title": "API Integration Guide",
  "type": "markdown",
  "content": "# API Integration\n\nThis guide covers...",
  "metadata": {
    "tags": ["api", "integration"],
    "category": "Technical",
    "status": "draft"
  },
  "settings": {
    "editor_mode": "wysiwyg",
    "ai_enabled": true,
    "auto_save": true
  }
}
```

**Response:** `201 Created`
```json
{
  "id": "doc_456def",
  "title": "API Integration Guide",
  "content_hash": "b7c9e2f3...",
  "created_at": "2025-12-05T10:30:00Z"
}
```

---

#### `GET /documents/{id}`

Get document by ID.

**Headers:**
```
If-None-Match: {content_hash}  # Optional: for caching
```

**Response:** `200 OK`
```json
{
  "id": "doc_123abc",
  "workspace_id": "ws_123",
  "title": "Getting Started Guide",
  "type": "markdown",
  "content": "# Getting Started\n\nWelcome to MD Creator...",
  "content_hash": "a3f5d1e2...",
  "metadata": {
    "tags": ["tutorial", "getting-started"],
    "category": "Documentation",
    "priority": "high",
    "status": "published"
  },
  "settings": {
    "editor_mode": "wysiwyg",
    "ai_enabled": true,
    "auto_save": true,
    "collaboration_enabled": true
  },
  "creator": {
    "id": "user_123",
    "display_name": "John Doe",
    "avatar_url": "https://..."
  },
  "last_editor": {
    "id": "user_456",
    "display_name": "Alice Smith",
    "avatar_url": "https://..."
  },
  "view_count": 142,
  "created_at": "2025-11-01T10:00:00Z",
  "updated_at": "2025-12-05T09:00:00Z",
  "last_viewed_at": "2025-12-05T09:30:00Z"
}
```

**Response:** `304 Not Modified` (if `If-None-Match` header matches)

---

#### `PUT /documents/{id}`

Update document (full replace).

**Headers:**
```
If-Match: {content_hash}  # Required: for optimistic locking
```

**Request:**
```json
{
  "title": "Getting Started Guide (Updated)",
  "content": "# Getting Started (Updated)\n\nWelcome...",
  "metadata": {
    "tags": ["tutorial", "getting-started", "beginner"],
    "status": "published"
  }
}
```

**Response:** `200 OK`
```json
{
  "id": "doc_123abc",
  "content_hash": "c8d1f3g4...",
  "updated_at": "2025-12-05T10:35:00Z"
}
```

**Errors:**
- `412 Precondition Failed`: `If-Match` header doesn't match (conflict)
  ```json
  {
    "type": "https://mdcreator.app/errors/edit-conflict",
    "title": "Edit Conflict",
    "status": 412,
    "detail": "Document was modified by another user",
    "server_version": {
      "content_hash": "z9y8x7w6...",
      "updated_at": "2025-12-05T10:34:00Z",
      "updated_by": {
        "id": "user_789",
        "display_name": "Bob Johnson"
      }
    }
  }
  ```

---

#### `PATCH /documents/{id}`

Partial update (specific fields).

**Request:**
```json
{
  "metadata": {
    "status": "archived"
  }
}
```

**Response:** `200 OK`

---

#### `DELETE /documents/{id}`

Soft delete document.

**Response:** `204 No Content`

---

#### `GET /documents/{id}/versions`

List document versions.

**Query Parameters:**
- `limit` (default: 20)
- `offset` (default: 0)

**Response:** `200 OK`
```json
{
  "versions": [
    {
      "id": "ver_abc123",
      "version_number": 15,
      "title": "Getting Started Guide",
      "content_hash": "a3f5d1e2...",
      "change_description": "Updated installation steps",
      "changes_summary": {
        "lines_added": 12,
        "lines_removed": 5,
        "lines_modified": 8
      },
      "created_by": {
        "id": "user_123",
        "display_name": "John Doe"
      },
      "created_at": "2025-12-05T09:00:00Z",
      "size_bytes": 4096
    }
  ],
  "total": 15
}
```

---

#### `POST /documents/{id}/versions`

Create manual version snapshot.

**Request:**
```json
{
  "change_description": "Completed first draft"
}
```

**Response:** `201 Created`
```json
{
  "version_id": "ver_xyz789",
  "version_number": 16
}
```

---

#### `GET /documents/{id}/versions/{version_number}`

Get specific version.

**Response:** `200 OK`
```json
{
  "id": "ver_abc123",
  "version_number": 15,
  "title": "Getting Started Guide",
  "content": "# Getting Started\n\n...",
  "content_hash": "a3f5d1e2...",
  "metadata_snapshot": {
    "tags": ["tutorial"],
    "status": "draft"
  },
  "created_by": {
    "id": "user_123",
    "display_name": "John Doe"
  },
  "created_at": "2025-12-05T09:00:00Z"
}
```

---

#### `POST /documents/{id}/restore-version`

Restore document to specific version.

**Request:**
```json
{
  "version_number": 14
}
```

**Response:** `200 OK`
```json
{
  "new_version_number": 17,
  "content_hash": "b7c9e2f3..."
}
```

---

### 6.5 Comment Endpoints

**Base URL**: `/api/v1/documents/{document_id}/comments`

#### `GET /documents/{document_id}/comments`

List comments for document.

**Query Parameters:**
- `resolved` (optional): Filter by resolution status

**Response:** `200 OK`
```json
{
  "comments": [
    {
      "id": "cmt_abc123",
      "thread_id": "cmt_abc123",
      "parent_id": null,
      "depth": 0,
      "author": {
        "id": "user_123",
        "display_name": "John Doe",
        "avatar_url": "https://..."
      },
      "content": "Great explanation! Could you add more examples?",
      "content_html": "<p>Great explanation! Could you add more examples?</p>",
      "position": {
        "from": 450,
        "to": 520,
        "blockId": "block_xyz"
      },
      "anchor_text": "This is the text the comment refers to",
      "mentions": ["user_456"],
      "resolved": false,
      "reactions": [
        {
          "emoji": "üëç",
          "users": ["user_789", "user_456"]
        }
      ],
      "reply_count": 3,
      "created_at": "2025-12-04T14:30:00Z",
      "updated_at": "2025-12-04T14:30:00Z"
    }
  ],
  "total": 12
}
```

---

#### `POST /documents/{document_id}/comments`

Create new comment.

**Request:**
```json
{
  "content": "This section needs clarification @alice",
  "parent_id": null,
  "position": {
    "from": 450,
    "to": 520,
    "blockId": "block_xyz"
  },
  "anchor_text": "Text being commented on",
  "mentions": ["user_456"]
}
```

**Response:** `201 Created`
```json
{
  "id": "cmt_def456",
  "thread_id": "cmt_def456",
  "created_at": "2025-12-05T10:30:00Z"
}
```

---

#### `PUT /comments/{id}`

Update comment.

**Request:**
```json
{
  "content": "Updated comment text"
}
```

**Response:** `200 OK`

---

#### `DELETE /comments/{id}`

Delete comment (soft delete).

**Response:** `204 No Content`

---

#### `POST /comments/{id}/resolve`

Mark comment as resolved.

**Response:** `200 OK`
```json
{
  "resolved": true,
  "resolved_by": {
    "id": "user_123",
    "display_name": "John Doe"
  },
  "resolved_at": "2025-12-05T10:35:00Z"
}
```

---

#### `POST /comments/{id}/reactions`

Add reaction to comment.

**Request:**
```json
{
  "emoji": "üëç"
}
```

**Response:** `201 Created`

---

### 6.6 Attachment & Upload Endpoints

**Base URL**: `/api/v1/uploads`

#### `POST /uploads/presign`

Get presigned URL for direct S3 upload.

**Request:**
```json
{
  "file_name": "architecture-diagram.png",
  "content_type": "image/png",
  "size_bytes": 524288,
  "scope": "attachment",
  "workspace_id": "ws_123",
  "document_id": "doc_456"
}
```

**Response:** `200 OK`
```json
{
  "upload_url": "https://s3.amazonaws.com/mdcreator-prod/...",
  "upload_fields": {
    "key": "attachments/ws_123/doc_456/...",
    "AWSAccessKeyId": "...",
    "policy": "...",
    "signature": "..."
  },
  "attachment_id": "att_xyz789",
  "expires_in": 300
}
```

**Usage:**
1. Client gets presigned URL from API
2. Client uploads file directly to S3 using presigned URL
3. Client confirms upload via `POST /uploads/{attachment_id}/confirm`

---

#### `POST /uploads/{attachment_id}/confirm`

Confirm file upload completion.

**Response:** `200 OK`
```json
{
  "attachment_id": "att_xyz789",
  "cdn_url": "https://cdn.mdcreator.app/attachments/...",
  "thumbnail_url": "https://cdn.mdcreator.app/thumbnails/...",
  "processing_status": "complete"
}
```

---

#### `GET /attachments/{id}`

Get attachment metadata.

**Response:** `200 OK`
```json
{
  "id": "att_xyz789",
  "file_name": "architecture-diagram.png",
  "content_type": "image/png",
  "size_bytes": 524288,
  "cdn_url": "https://cdn.mdcreator.app/...",
  "thumbnail_url": "https://cdn.mdcreator.app/thumbnails/...",
  "metadata": {
    "width": 1920,
    "height": 1080,
    "format": "PNG"
  },
  "uploaded_by": {
    "id": "user_123",
    "display_name": "John Doe"
  },
  "uploaded_at": "2025-12-05T10:30:00Z"
}
```

---

#### `DELETE /attachments/{id}`

Delete attachment.

**Response:** `204 No Content`

---

### 6.7 Sync Endpoints

**Base URL**: `/api/v1/sync`

#### `GET /sync/workspaces/{workspace_id}/since`

Get changes since cursor.

**Query Parameters:**
- `cursor` (required): Last sync cursor (0 for initial sync)
- `limit` (default: 100): Max changes to return

**Response:** `200 OK`
```json
{
  "documents": [
    {
      "operation": "update",
      "entity_id": "doc_123",
      "timestamp": "2025-12-05T10:30:00Z",
      "changed_by": "user_456",
      "changes": {
        "old": {"title": "Old Title"},
        "new": {"title": "New Title"}
      }
    }
  ],
  "comments": [],
  "attachments": [],
  "cursor": 12450,
  "has_more": false,
  "timestamp": "2025-12-05T10:35:00Z"
}
```

---

#### `POST /sync/workspaces/{workspace_id}/push`

Push local changes to server.

**Request:**
```json
{
  "changes": [
    {
      "entity_type": "document",
      "entity_id": "doc_123",
      "operation": "update",
      "data": {
        "title": "Updated Title",
        "content": "Updated content...",
        "base_content_hash": "a3f5d1e2..."
      }
    }
  ]
}
```

**Response:** `200 OK`
```json
{
  "results": [
    {
      "entity_id": "doc_123",
      "status": "success",
      "result": {
        "content_hash": "c8d1f3g4..."
      }
    }
  ]
}
```

---

### 6.8 AI Proxy Endpoints

**Base URL**: `/api/v1/ai`

#### `POST /ai/generate`

Generate content using AI (optional proxy for API keys).

**Request:**
```json
{
  "provider": "openai",
  "model": "gpt-4",
  "prompt": "Generate a project roadmap for a SaaS application",
  "context_ids": ["doc_123", "doc_456"],
  "options": {
    "temperature": 0.7,
    "max_tokens": 2000
  }
}
```

**Response:** `200 OK`
```json
{
  "content": "# SaaS Application Roadmap\n\n## Phase 1...",
  "provider": "openai",
  "model": "gpt-4",
  "tokens_used": 1245,
  "cost_estimate": 0.024,
  "generated_at": "2025-12-05T10:30:00Z"
}
```

**Errors:**
- `429 Too Many Requests`: Rate limit exceeded
- `402 Payment Required`: Insufficient credits

---

#### `POST /ai/generate-diagram`

Generate Mermaid diagram.

**Request:**
```json
{
  "description": "User authentication flow with OAuth",
  "diagram_type": "sequence"
}
```

**Response:** `200 OK`
```json
{
  "mermaid_code": "sequenceDiagram\n    participant User\n    participant App\n    participant OAuth\n    User->>App: Login\n    App->>OAuth: Authorize...",
  "validated": true
}
```

---

### 6.9 WebSocket API (Real-Time Collaboration)

**WebSocket URL**: `wss://api.mdcreator.app/ws`

**Connection:**
```javascript
const ws = new WebSocket('wss://api.mdcreator.app/ws?token={access_token}&document_id={doc_id}');

ws.onopen = () => {
  console.log('Connected to document collaboration');
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  handleRealtimeUpdate(message);
};
```

**Message Types:**

1. **Presence Update** (someone joins/leaves):
```json
{
  "type": "presence",
  "action": "join",
  "user": {
    "id": "user_123",
    "display_name": "John Doe",
    "avatar_url": "https://...",
    "cursor_position": {"from": 100, "to": 100}
  },
  "document_id": "doc_456",
  "timestamp": "2025-12-05T10:30:00Z"
}
```

2. **Cursor Position**:
```json
{
  "type": "cursor",
  "user_id": "user_123",
  "position": {
    "from": 150,
    "to": 165
  },
  "is_typing": true
}
```

3. **Document Update** (Yjs CRDT sync):
```json
{
  "type": "document_update",
  "document_id": "doc_456",
  "update": "base64_encoded_yjs_update",
  "user_id": "user_123"
}
```

4. **Comment Added**:
```json
{
  "type": "comment",
  "action": "create",
  "comment": {
    "id": "cmt_xyz",
    "author": {...},
    "content": "...",
    "position": {...}
  }
}
```

---

**Next**: Part 5 - Deployment & Development Handover

